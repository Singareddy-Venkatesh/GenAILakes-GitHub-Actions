name: CI-CD with Security Scans and Deploy

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  scan:
    name: Security Scans
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Gitleaks - Secret scanning
        uses: zricethezav/gitleaks-action@v2
        with:
          args: detect --source . --no-git -v

      - name: Install Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update -y
          sudo apt-get install -y trivy

      - name: Trivy filesystem scan
        run: trivy fs --exit-code 0 --severity HIGH,CRITICAL .

  sonar:
    name: SonarQube Analysis
    runs-on: self-hosted
    needs: scan
    env:
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: SonarScanner using Docker
        run: |
          docker run --rm \
            -e SONAR_HOST_URL=${{ secrets.SONAR_HOST_URL }} \
            -e SONAR_LOGIN=${{ secrets.SONAR_TOKEN }} \
            -v "$(pwd)":/usr/src \
            sonarsource/sonar-scanner-cli \
            -Dsonar.projectKey=fastleads99 \
            -Dsonar.sources=/usr/src \
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}

  build_and_push:
    name: Build & Push Docker Images
    runs-on: self-hosted
    needs: sonar
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Docker Hub Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & push backend
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/fastleads-backend:latest

      - name: Build & push frontend
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/fastleads-frontend:latest

  deploy:
    name: Deploy to Self-Hosted Runner
    runs-on: self-hosted
    needs: build_and_push
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run deploy script
        run: |
          chmod +x ./deploy.sh
          ./deploy.sh
